<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatwoot å¢å¼ºç”¨æˆ·ç®¡ç†åŠŸèƒ½æ¼”ç¤º</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #1f93ff;
            text-align: center;
            margin-bottom: 30px;
        }
        .demo-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #1f93ff;
        }
        .button {
            background: #1f93ff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .button:hover {
            background: #1e40af;
            transform: translateY(-1px);
        }
        .button.success {
            background: #10b981;
        }
        .button.warning {
            background: #f59e0b;
        }
        .button.danger {
            background: #ef4444;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin: 5px;
            display: inline-block;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .checkbox-group input {
            width: auto;
            margin-right: 8px;
        }
        #output {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Chatwoot å¢å¼ºç”¨æˆ·ç®¡ç†åŠŸèƒ½æ¼”ç¤º</h1>
        
        <div class="demo-section">
            <h3>ğŸ“Š åŠŸèƒ½çŠ¶æ€æ£€æŸ¥</h3>
            <button class="button" onclick="checkFeatureStatus()">æ£€æŸ¥å¢å¼ºåŠŸèƒ½çŠ¶æ€</button>
            <button class="button success" onclick="loadEnhancedAPI()">åŠ è½½å¢å¼ºAPI</button>
            <button class="button warning" onclick="loadUIEnhancer()">åŠ è½½UIå¢å¼ºå™¨</button>
            <div id="status-display" style="margin-top: 10px;"></div>
        </div>
        
        <div class="demo-section">
            <h3>ğŸ‘¥ ç”¨æˆ·ç®¡ç†æ¼”ç¤º</h3>
            
            <h4>åˆ›å»ºæ–°ç”¨æˆ·</h4>
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="demo-name" placeholder="è¾“å…¥ç”¨æˆ·å§“å" value="Demo User">
            </div>
            <div class="form-group">
                <label>é‚®ç®±</label>
                <input type="email" id="demo-email" placeholder="è¾“å…¥é‚®ç®±åœ°å€" value="demo@example.com">
            </div>
            <div class="form-group">
                <label>è§’è‰²</label>
                <select id="demo-role">
                    <option value="agent">ä»£ç†</option>
                    <option value="administrator">ç®¡ç†å‘˜</option>
                </select>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="demo-auto-password" checked>
                <label for="demo-auto-password">è‡ªåŠ¨ç”Ÿæˆå¯†ç </label>
            </div>
            
            <div id="demo-manual-password" style="display: none;">
                <div class="form-group">
                    <label>è‡ªå®šä¹‰å¯†ç </label>
                    <input type="password" id="demo-password" placeholder="è¾“å…¥å¯†ç ï¼ˆæœ€å°‘8ä½ï¼‰">
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤å¯†ç </label>
                    <input type="password" id="demo-confirm-password" placeholder="ç¡®è®¤å¯†ç ">
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="demo-confirmed">
                <label for="demo-confirmed">ç«‹å³è®¤è¯è´¦å·</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="demo-welcome-email">
                <label for="demo-welcome-email">å‘é€æ¬¢è¿é‚®ä»¶</label>
            </div>
            
            <button class="button success" onclick="createDemoUser()">åˆ›å»ºç”¨æˆ·</button>
            
            <h4 style="margin-top: 30px;">ç”¨æˆ·ç®¡ç†æ“ä½œ</h4>
            <div class="form-group">
                <label>ç”¨æˆ·ID</label>
                <input type="number" id="demo-user-id" placeholder="è¾“å…¥ç”¨æˆ·ID" value="1">
            </div>
            
            <button class="button" onclick="getUserInfo()">è·å–ç”¨æˆ·ä¿¡æ¯</button>
            <button class="button warning" onclick="toggleUserConfirmation()">åˆ‡æ¢è®¤è¯çŠ¶æ€</button>
            <button class="button danger" onclick="resetUserPassword()">é‡ç½®å¯†ç </button>
        </div>
        
        <div class="demo-section">
            <h3>ğŸ”§ ç›´æ¥é›†æˆåˆ°Chatwoot</h3>
            <p>ä»¥ä¸‹æŒ‰é’®å°†ç›´æ¥åœ¨å½“å‰Chatwooté¡µé¢ä¸­åŠ è½½å¢å¼ºåŠŸèƒ½ï¼š</p>
            
            <button class="button" onclick="injectToCurrentPage()">æ³¨å…¥åˆ°å½“å‰é¡µé¢</button>
            <button class="button success" onclick="openChatwootWithEnhancements()">æ‰“å¼€å¢å¼ºç‰ˆChatwoot</button>
            
            <div style="margin-top: 15px;">
                <h4>ä½¿ç”¨è¯´æ˜ï¼š</h4>
                <ol style="color: #6b7280; font-size: 14px;">
                    <li>ç‚¹å‡»"æ³¨å…¥åˆ°å½“å‰é¡µé¢"å°†å¢å¼ºåŠŸèƒ½æ·»åŠ åˆ°å½“å‰Chatwootç•Œé¢</li>
                    <li>ç‚¹å‡»"æ‰“å¼€å¢å¼ºç‰ˆChatwoot"åœ¨æ–°çª—å£ä¸­æ‰“å¼€å¸¦æœ‰å¢å¼ºåŠŸèƒ½çš„Chatwoot</li>
                    <li>åœ¨Chatwootä¸­è¿›å…¥"è®¾ç½®" â†’ "ä»£ç†ç®¡ç†"æŸ¥çœ‹å¢å¼ºé€‰é¡¹</li>
                    <li>æ·»åŠ æˆ–ç¼–è¾‘ä»£ç†æ—¶å¯ä»¥çœ‹åˆ°å¯†ç è®¾ç½®å’Œè®¤è¯æ§åˆ¶åŠŸèƒ½</li>
                </ol>
            </div>
        </div>
        
        <div class="demo-section">
            <h3>ğŸ“ è¾“å‡ºæ—¥å¿—</h3>
            <div id="output">ç­‰å¾…æ“ä½œ...</div>
            <button class="button" onclick="clearOutput()">æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <script>
        // è¾“å‡ºæ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').textContent = '';
        }

        // æ£€æŸ¥åŠŸèƒ½çŠ¶æ€
        function checkFeatureStatus() {
            log('æ£€æŸ¥å¢å¼ºåŠŸèƒ½çŠ¶æ€...');
            
            // æ£€æŸ¥APIå®¢æˆ·ç«¯
            fetch('/enhanced_agents_api.js')
                .then(response => {
                    if (response.ok) {
                        log('âœ“ å¢å¼ºAPIå®¢æˆ·ç«¯å¯è®¿é—®', 'success');
                        updateStatus('enhanced-api', true);
                    } else {
                        log('âœ— å¢å¼ºAPIå®¢æˆ·ç«¯ä¸å¯è®¿é—®', 'error');
                        updateStatus('enhanced-api', false);
                    }
                })
                .catch(error => {
                    log('âœ— APIå®¢æˆ·ç«¯æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
                    updateStatus('enhanced-api', false);
                });

            // æ£€æŸ¥UIå¢å¼ºå™¨
            fetch('/chatwoot_ui_enhancer.js')
                .then(response => {
                    if (response.ok) {
                        log('âœ“ UIå¢å¼ºå™¨å¯è®¿é—®', 'success');
                        updateStatus('ui-enhancer', true);
                    } else {
                        log('âœ— UIå¢å¼ºå™¨ä¸å¯è®¿é—®', 'error');
                        updateStatus('ui-enhancer', false);
                    }
                })
                .catch(error => {
                    log('âœ— UIå¢å¼ºå™¨æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
                    updateStatus('ui-enhancer', false);
                });

            // æ£€æŸ¥ChatwootæœåŠ¡
            fetch('/')
                .then(response => {
                    if (response.ok) {
                        log('âœ“ ChatwootæœåŠ¡æ­£å¸¸', 'success');
                        updateStatus('chatwoot', true);
                    } else {
                        log('âœ— ChatwootæœåŠ¡å¼‚å¸¸', 'error');
                        updateStatus('chatwoot', false);
                    }
                })
                .catch(error => {
                    log('âœ— ChatwootæœåŠ¡æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
                    updateStatus('chatwoot', false);
                });
        }

        function updateStatus(component, status) {
            const statusDisplay = document.getElementById('status-display');
            const statusClass = status ? 'success' : 'error';
            const statusText = status ? 'æ­£å¸¸' : 'å¼‚å¸¸';
            const componentName = {
                'enhanced-api': 'å¢å¼ºAPI',
                'ui-enhancer': 'UIå¢å¼ºå™¨',
                'chatwoot': 'ChatwootæœåŠ¡'
            }[component];

            const statusElement = document.createElement('span');
            statusElement.className = `status ${statusClass}`;
            statusElement.textContent = `${componentName}: ${statusText}`;
            statusDisplay.appendChild(statusElement);
        }

        // åŠ è½½å¢å¼ºAPI
        function loadEnhancedAPI() {
            log('åŠ è½½å¢å¼ºAPIå®¢æˆ·ç«¯...');
            
            const script = document.createElement('script');
            script.src = '/enhanced_agents_api.js';
            script.onload = () => {
                log('âœ“ å¢å¼ºAPIå®¢æˆ·ç«¯åŠ è½½æˆåŠŸ', 'success');
                if (window.enhancedAgentsAPI) {
                    log('âœ“ enhancedAgentsAPI å¯¹è±¡å¯ç”¨', 'success');
                }
            };
            script.onerror = () => {
                log('âœ— å¢å¼ºAPIå®¢æˆ·ç«¯åŠ è½½å¤±è´¥', 'error');
            };
            
            document.head.appendChild(script);
        }

        // åŠ è½½UIå¢å¼ºå™¨
        function loadUIEnhancer() {
            log('åŠ è½½UIå¢å¼ºå™¨...');
            
            const script = document.createElement('script');
            script.src = '/chatwoot_ui_enhancer.js';
            script.onload = () => {
                log('âœ“ UIå¢å¼ºå™¨åŠ è½½æˆåŠŸ', 'success');
            };
            script.onerror = () => {
                log('âœ— UIå¢å¼ºå™¨åŠ è½½å¤±è´¥', 'error');
            };
            
            document.head.appendChild(script);
        }

        // åˆ›å»ºæ¼”ç¤ºç”¨æˆ·
        function createDemoUser() {
            if (!window.enhancedAgentsAPI) {
                log('è¯·å…ˆåŠ è½½å¢å¼ºAPIå®¢æˆ·ç«¯', 'error');
                return;
            }

            const userData = {
                name: document.getElementById('demo-name').value,
                email: document.getElementById('demo-email').value,
                role: document.getElementById('demo-role').value,
                auto_generate_password: document.getElementById('demo-auto-password').checked,
                confirmed: document.getElementById('demo-confirmed').checked,
                send_welcome_email: document.getElementById('demo-welcome-email').checked
            };

            if (!userData.auto_generate_password) {
                userData.password = document.getElementById('demo-password').value;
                userData.password_confirmation = document.getElementById('demo-confirm-password').value;
            }

            log(`åˆ›å»ºç”¨æˆ·: ${userData.name} (${userData.email})`);

            window.enhancedAgentsAPI.createAgent(userData)
                .then(result => {
                    log('âœ“ ç”¨æˆ·åˆ›å»ºæˆåŠŸ: ' + JSON.stringify(result, null, 2), 'success');
                })
                .catch(error => {
                    log('âœ— ç”¨æˆ·åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                });
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        function getUserInfo() {
            if (!window.enhancedAgentsAPI) {
                log('è¯·å…ˆåŠ è½½å¢å¼ºAPIå®¢æˆ·ç«¯', 'error');
                return;
            }

            const userId = document.getElementById('demo-user-id').value;
            log(`è·å–ç”¨æˆ·ä¿¡æ¯: ID ${userId}`);

            window.enhancedAgentsAPI.getAgent(userId)
                .then(result => {
                    log('âœ“ ç”¨æˆ·ä¿¡æ¯: ' + JSON.stringify(result, null, 2), 'success');
                })
                .catch(error => {
                    log('âœ— è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
                });
        }

        // åˆ‡æ¢ç”¨æˆ·è®¤è¯çŠ¶æ€
        function toggleUserConfirmation() {
            if (!window.enhancedAgentsAPI) {
                log('è¯·å…ˆåŠ è½½å¢å¼ºAPIå®¢æˆ·ç«¯', 'error');
                return;
            }

            const userId = document.getElementById('demo-user-id').value;
            log(`åˆ‡æ¢ç”¨æˆ·è®¤è¯çŠ¶æ€: ID ${userId}`);

            window.enhancedAgentsAPI.toggleConfirmation(userId)
                .then(result => {
                    log('âœ“ è®¤è¯çŠ¶æ€åˆ‡æ¢æˆåŠŸ: ' + result.message, 'success');
                })
                .catch(error => {
                    log('âœ— è®¤è¯çŠ¶æ€åˆ‡æ¢å¤±è´¥: ' + error.message, 'error');
                });
        }

        // é‡ç½®ç”¨æˆ·å¯†ç 
        function resetUserPassword() {
            if (!window.enhancedAgentsAPI) {
                log('è¯·å…ˆåŠ è½½å¢å¼ºAPIå®¢æˆ·ç«¯', 'error');
                return;
            }

            const userId = document.getElementById('demo-user-id').value;
            const newPassword = prompt('è¾“å…¥æ–°å¯†ç ï¼ˆç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰:');
            const forceChange = confirm('æ˜¯å¦è¦æ±‚ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶ä¿®æ”¹å¯†ç ï¼Ÿ');

            log(`é‡ç½®ç”¨æˆ·å¯†ç : ID ${userId}`);

            window.enhancedAgentsAPI.resetPassword(userId, {
                password: newPassword,
                force_password_change: forceChange
            })
                .then(result => {
                    log('âœ“ å¯†ç é‡ç½®æˆåŠŸï¼Œæ–°å¯†ç : ' + result.password, 'success');
                })
                .catch(error => {
                    log('âœ— å¯†ç é‡ç½®å¤±è´¥: ' + error.message, 'error');
                });
        }

        // æ³¨å…¥åˆ°å½“å‰é¡µé¢
        function injectToCurrentPage() {
            log('æ³¨å…¥å¢å¼ºåŠŸèƒ½åˆ°å½“å‰é¡µé¢...');
            
            // åŠ è½½ä¸¤ä¸ªå¢å¼ºè„šæœ¬
            loadEnhancedAPI();
            setTimeout(() => {
                loadUIEnhancer();
                log('âœ“ å¢å¼ºåŠŸèƒ½å·²æ³¨å…¥åˆ°å½“å‰é¡µé¢', 'success');
            }, 1000);
        }

        // æ‰“å¼€å¢å¼ºç‰ˆChatwoot
        function openChatwootWithEnhancements() {
            log('æ‰“å¼€å¢å¼ºç‰ˆChatwoot...');
            
            const chatwootURL = 'http://localhost:3000';
            const enhancedWindow = window.open(chatwootURL, '_blank');
            
            // ç­‰å¾…é¡µé¢åŠ è½½åæ³¨å…¥å¢å¼ºåŠŸèƒ½
            setTimeout(() => {
                try {
                    // æ³¨å…¥å¢å¼ºAPI
                    const apiScript = enhancedWindow.document.createElement('script');
                    apiScript.src = '/enhanced_agents_api.js';
                    enhancedWindow.document.head.appendChild(apiScript);
                    
                    // æ³¨å…¥UIå¢å¼ºå™¨
                    setTimeout(() => {
                        const uiScript = enhancedWindow.document.createElement('script');
                        uiScript.src = '/chatwoot_ui_enhancer.js';
                        enhancedWindow.document.head.appendChild(uiScript);
                        
                        log('âœ“ å¢å¼ºåŠŸèƒ½å·²æ³¨å…¥åˆ°æ–°çª—å£', 'success');
                    }, 1000);
                } catch (error) {
                    log('âœ— æ— æ³•æ³¨å…¥åˆ°æ–°çª—å£ï¼ˆè·¨åŸŸé™åˆ¶ï¼‰: ' + error.message, 'error');
                    log('è¯·æ‰‹åŠ¨åœ¨æ–°çª—å£çš„æ§åˆ¶å°ä¸­è¿è¡Œå¢å¼ºè„šæœ¬', 'info');
                }
            }, 2000);
        }

        // å¯†ç å­—æ®µæ˜¾ç¤º/éšè—
        document.getElementById('demo-auto-password').addEventListener('change', function() {
            const manualPasswordDiv = document.getElementById('demo-manual-password');
            manualPasswordDiv.style.display = this.checked ? 'none' : 'block';
        });

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', () => {
            log('æ¼”ç¤ºé¡µé¢åŠ è½½å®Œæˆ');
            setTimeout(checkFeatureStatus, 1000);
        });
    </script>
</body>
</html>
