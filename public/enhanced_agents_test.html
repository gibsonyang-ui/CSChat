<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢å¼ºç”¨æˆ·ç®¡ç†åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #667eea;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .content {
            padding: 20px;
        }
        .status-section {
            margin: 20px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            background: #f8f9ff;
        }
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #5a6fd8;
        }
        .button.success {
            background: #10b981;
        }
        .button.danger {
            background: #ef4444;
        }
        .button.secondary {
            background: #6b7280;
        }
        .agents-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .agents-table th,
        .agents-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .agents-table th {
            background: #f9fafb;
            font-weight: 600;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .action-buttons .button {
            padding: 6px 12px;
            font-size: 12px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Chatwoot å¢å¼ºç”¨æˆ·ç®¡ç†åŠŸèƒ½</h1>
            <p>å¼€å‘ç¯å¢ƒæµ‹è¯•é¡µé¢</p>
        </div>
        
        <div class="content">
            <div class="status-section">
                <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h3>
                <p><strong>APIçŠ¶æ€:</strong> <span id="api-status">æ£€æŸ¥ä¸­...</span></p>
                <p><strong>å½“å‰è´¦æˆ·:</strong> <span id="current-account">åŠ è½½ä¸­...</span></p>
                <p><strong>ç”¨æˆ·æ•°é‡:</strong> <span id="user-count">-</span></p>
                <button class="button" onclick="checkAPIStatus()">åˆ·æ–°çŠ¶æ€</button>
                <button class="button secondary" onclick="loadAgents()">åŠ è½½ç”¨æˆ·åˆ—è¡¨</button>
            </div>

            <div id="alerts"></div>

            <div class="status-section">
                <h3>ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨</h3>
                <table class="agents-table" id="agents-table">
                    <thead>
                        <tr>
                            <th>å§“å</th>
                            <th>é‚®ç®±</th>
                            <th>è§’è‰²</th>
                            <th>è®¤è¯çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="agents-tbody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #6b7280;">
                                ç‚¹å‡»"åŠ è½½ç”¨æˆ·åˆ—è¡¨"æŒ‰é’®è·å–æ•°æ®
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="status-section">
                <h3>ğŸ”§ åŠŸèƒ½æµ‹è¯•</h3>
                <button class="button" onclick="testToggleConfirmation()">æµ‹è¯•è®¤è¯åˆ‡æ¢</button>
                <button class="button" onclick="testPasswordReset()">æµ‹è¯•å¯†ç é‡ç½®</button>
                <button class="button secondary" onclick="openTestPasswordModal()">æ‰“å¼€å¯†ç é‡ç½®å¯¹è¯æ¡†</button>
            </div>
        </div>
    </div>

    <!-- å¯†ç é‡ç½®æ¨¡æ€æ¡† -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ”‘ é‡ç½®å¯†ç </h3>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="auto-generate" checked> è‡ªåŠ¨ç”Ÿæˆå®‰å…¨å¯†ç  (æ¨è)
                </label>
            </div>
            <div id="manual-password" style="display: none;">
                <div class="form-group">
                    <label for="new-password">æ–°å¯†ç :</label>
                    <input type="password" id="new-password" placeholder="è‡³å°‘8ä½">
                </div>
                <div class="form-group">
                    <label for="confirm-password">ç¡®è®¤å¯†ç :</label>
                    <input type="password" id="confirm-password" placeholder="å†æ¬¡è¾“å…¥å¯†ç ">
                </div>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="button secondary" onclick="closePasswordModal()">å–æ¶ˆ</button>
                <button class="button" onclick="executePasswordReset()">é‡ç½®å¯†ç </button>
            </div>
        </div>
    </div>

    <script>
        let currentAgents = [];
        let selectedAgent = null;

        // æ£€æŸ¥APIçŠ¶æ€
        async function checkAPIStatus() {
            try {
                const response = await fetch('/api/v1/accounts/1/enhanced_agents/status');
                const data = await response.json();
                
                document.getElementById('api-status').innerHTML = 
                    `<span style="color: #10b981;">âœ… æ­£å¸¸</span>`;
                document.getElementById('current-account').textContent = data.account_id || '1';
                document.getElementById('user-count').textContent = data.user_count || '0';
                
                showAlert('success', 'APIè¿æ¥æ­£å¸¸');
            } catch (error) {
                document.getElementById('api-status').innerHTML = 
                    `<span style="color: #ef4444;">âŒ é”™è¯¯: ${error.message}</span>`;
                showAlert('error', 'APIè¿æ¥å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadAgents() {
            try {
                const response = await fetch('/api/v1/accounts/1/enhanced_agents');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const agents = await response.json();
                currentAgents = agents;
                renderAgentsTable(agents);
                showAlert('success', `æˆåŠŸåŠ è½½ ${agents.length} ä¸ªç”¨æˆ·`);
            } catch (error) {
                showAlert('error', 'åŠ è½½ç”¨æˆ·å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
        function renderAgentsTable(agents) {
            const tbody = document.getElementById('agents-tbody');
            
            if (agents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = agents.map(agent => `
                <tr>
                    <td>${agent.name}</td>
                    <td>${agent.email}</td>
                    <td>${agent.role}</td>
                    <td>
                        <span style="color: ${agent.confirmed ? '#10b981' : '#f59e0b'};">
                            ${agent.confirmed ? 'âœ… å·²è®¤è¯' : 'â³ å¾…è®¤è¯'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="button ${agent.confirmed ? 'danger' : 'success'}" 
                                    onclick="toggleConfirmation(${agent.id})">
                                ${agent.confirmed ? 'âŒ æ’¤é”€è®¤è¯' : 'âœ… ç¡®è®¤è®¤è¯'}
                            </button>
                            <button class="button secondary" onclick="openPasswordModal(${agent.id})">
                                ğŸ”‘ é‡ç½®å¯†ç 
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // åˆ‡æ¢è®¤è¯çŠ¶æ€
        async function toggleConfirmation(agentId) {
            try {
                const response = await fetch(`/api/v1/accounts/1/enhanced_agents/${agentId}/toggle_confirmation`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                showAlert('success', data.message);
                loadAgents(); // é‡æ–°åŠ è½½åˆ—è¡¨
            } catch (error) {
                showAlert('error', 'æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // æ‰“å¼€å¯†ç é‡ç½®æ¨¡æ€æ¡†
        function openPasswordModal(agentId) {
            selectedAgent = currentAgents.find(a => a.id === agentId);
            if (selectedAgent) {
                document.querySelector('#password-modal h3').textContent = 
                    `ğŸ”‘ é‡ç½®å¯†ç  - ${selectedAgent.name}`;
                document.getElementById('password-modal').classList.add('show');
            }
        }

        function openTestPasswordModal() {
            selectedAgent = { id: 1, name: 'æµ‹è¯•ç”¨æˆ·' };
            document.querySelector('#password-modal h3').textContent = 
                `ğŸ”‘ é‡ç½®å¯†ç  - ${selectedAgent.name}`;
            document.getElementById('password-modal').classList.add('show');
        }

        function closePasswordModal() {
            document.getElementById('password-modal').classList.remove('show');
            selectedAgent = null;
        }

        // æ‰§è¡Œå¯†ç é‡ç½®
        async function executePasswordReset() {
            if (!selectedAgent) return;

            const autoGenerate = document.getElementById('auto-generate').checked;
            let requestData = {};

            if (autoGenerate) {
                requestData.auto_generate_password = true;
            } else {
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                if (!newPassword || newPassword.length < 8) {
                    showAlert('error', 'å¯†ç é•¿åº¦è‡³å°‘8ä½');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showAlert('error', 'å¯†ç ç¡®è®¤ä¸åŒ¹é…');
                    return;
                }

                requestData.password = newPassword;
                requestData.password_confirmation = confirmPassword;
            }

            try {
                const response = await fetch(`/api/v1/accounts/1/enhanced_agents/${selectedAgent.id}/reset_password`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                showAlert('success', `å¯†ç é‡ç½®æˆåŠŸï¼æ–°å¯†ç : ${data.password}`, 10000);
                closePasswordModal();
                loadAgents(); // é‡æ–°åŠ è½½åˆ—è¡¨
            } catch (error) {
                showAlert('error', 'å¯†ç é‡ç½®å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(type, message, duration = 5000) {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            
            alertsContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, duration);
        }

        // æµ‹è¯•å‡½æ•°
        function testToggleConfirmation() {
            showAlert('success', 'è®¤è¯åˆ‡æ¢åŠŸèƒ½å·²å‡†å¤‡å°±ç»ªï¼è¯·å…ˆåŠ è½½ç”¨æˆ·åˆ—è¡¨è¿›è¡Œæµ‹è¯•ã€‚');
        }

        function testPasswordReset() {
            showAlert('success', 'å¯†ç é‡ç½®åŠŸèƒ½å·²å‡†å¤‡å°±ç»ªï¼è¯·å…ˆåŠ è½½ç”¨æˆ·åˆ—è¡¨è¿›è¡Œæµ‹è¯•ã€‚');
        }

        // è‡ªåŠ¨ç”Ÿæˆå¯†ç åˆ‡æ¢
        document.getElementById('auto-generate').addEventListener('change', function() {
            const manualPassword = document.getElementById('manual-password');
            manualPassword.style.display = this.checked ? 'none' : 'block';
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥APIçŠ¶æ€
        window.addEventListener('load', function() {
            checkAPIStatus();
        });
    </script>
</body>
</html>
